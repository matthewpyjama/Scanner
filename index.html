<script>
  window.onload = async function() {
    const scanButton = document.getElementById('scan-button');
    const status = document.getElementById('status');
    const resultDiv = document.getElementById('result');
    const barcodeType = document.getElementById('barcode-type');
    const barcodeValue = document.getElementById('barcode-value');
    const itemImage = document.getElementById('itemImage');
    const itemName = document.getElementById('item-name');
    const googleBtn = document.getElementById('google-btn');
    const redirectBtn = document.getElementById('redirect-btn');
    const dismissBtn = document.getElementById('dismiss-btn');
    const reloadButton = document.getElementById('reload-button');

    const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzD-kW76mbuh3ZZWe7ZB3kIkgVTYmsMJ7uluEcknSpxlCE3vKwMhoE8roTTAVhe3jmX/exec';

    async function initializeScanbot() {
      try {
        console.log('[DEBUG] Checking if ScanbotSDK is available...');
        const ScanbotSDK = window.ScanbotSDK;
        if (!ScanbotSDK) {
          throw new Error('Scanbot SDK not loaded. Please ensure the script and engine files are included correctly.');
        }
        console.log('[DEBUG] ScanbotSDK found. Initializing SDK...');
        const scanbotSDK = await ScanbotSDK.initialize({
          licenseKey: '', // Empty for trial mode
          engine: {
            barcode: 'lib/' // Updated path to point directly to lib/
          }
        });
        console.log('[DEBUG] SDK initialized successfully:', scanbotSDK);
        return scanbotSDK;
      } catch (err) {
        console.error('Scanbot initialization error:', err);
        status.textContent = `Error: ${err.message}. Please reload and try again.`;
        return null;
      }
    }

    async function startBarcodeScanner() {
      console.log('[DEBUG] Starting barcode scanner...');
      const sdk = await initializeScanbot();
      if (!sdk) {
        console.log('[DEBUG] SDK initialization failed. Cannot start scanner.');
        return;
      }

      try {
        status.textContent = 'Starting scanner...';
        console.log('[DEBUG] Launching Scanbot UI...');
        const result = await sdk.UI.startBarcodeScanner({
          barcodeFormats: ['EAN_13', 'UPC_A', 'CODE_128', 'QR_CODE'],
          camera: {
            preferredCamera: 'environment'
          },
          singleScanMode: true
        });
        console.log('[DEBUG] Scanbot UI result:', result);

        if (result.canceled) {
          status.textContent = 'Scan canceled.';
          return;
        }

        if (result.barcodes && result.barcodes.length > 0) {
          const barcode = result.barcodes[0].text;
          const format = result.barcodes[0].format;
          console.log(`[DEBUG] Detected barcode: ${barcode}, format: ${format}`);
          status.textContent = `Scanned barcode: ${barcode}`;

          try {
            status.textContent = 'Fetching item data...';
            console.log(`[DEBUG] Fetching data for barcode: ${barcode}`);
            const response = await fetch(`${GOOGLE_APPS_SCRIPT_URL}?code=${barcode}`);
            if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
            const data = await response.json();
            console.log(`[DEBUG] Fetch response:`, data);

            barcodeType.textContent = `Type: ${format}`;
            barcodeValue.textContent = `Value: ${barcode}`;
            if (data.error || !data.itemName) {
              itemName.textContent = 'Item not found';
              itemImage.style.display = 'none';
            } else {
              itemName.textContent = `Item: ${data.itemName}`;
              if (data.imageUrl) {
                itemImage.src = data.imageUrl;
                itemImage.style.display = 'block';
              } else {
                itemImage.style.display = 'none';
              }
            }
            resultDiv.style.display = 'block';
            status.style.display = 'none';
          } catch (fetchErr) {
            console.error('Fetch error:', fetchErr);
            status.textContent = `Error: ${fetchErr.message}`;
            setTimeout(() => {
              resultDiv.style.display = 'block';
              barcodeType.textContent = 'Error';
              barcodeValue.textContent = `Error fetching item: ${fetchErr.message}`;
              itemImage.style.display = 'none';
              status.style.display = 'none';
            }, 5000);
          }

          googleBtn.onclick = () => {
            window.open(`https://www.google.com/search?q=${barcode}`, '_blank');
          };

          redirectBtn.onclick = () => {
            const itemPage = `item.html?code=${barcode}&name=${encodeURIComponent(data.itemName || 'Not Found')}&image=${encodeURIComponent(data.imageUrl || '')}`;
            window.location.href = itemPage;
          };

          dismissBtn.onclick = () => {
            resultDiv.style.display = 'none';
            status.style.display = 'block';
            status.textContent = 'Ready to scan (1-minute session)';
          };
        } else {
          status.textContent = 'No barcode detected. Please try again.';
        }
      } catch (err) {
        console.error('Scanbot error:', err);
        status.textContent = `Error: ${err.message}. Session may have expired.`;
        reloadButton.style.display = 'block';
        setTimeout(() => {
          status.textContent = 'Ready to scan (1-minute session)';
          reloadButton.style.display = 'none';
        }, 5000);
      }
    }

    scanButton.onclick = startBarcodeScanner;

    reloadButton.onclick = () => {
      window.location.reload();
    };
  };
</script>
