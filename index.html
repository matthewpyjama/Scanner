<!DOCTYPE html>
<html>
<head>
  <title>Barcode Scanner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background: #f0f0f0;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }
    #status {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 14px;
      z-index: 10;
    }
    #capture-button {
      padding: 15px 30px;
      font-size: 18px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      z-index: 20;
      margin-bottom: 20px;
    }
    #photo-preview {
      max-width: 90%;
      max-height: 50vh;
      border-radius: 10px;
      margin: 10px 0;
      display: none;
    }
    #result {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      width: 90%;
      max-width: 400px;
      max-height: 80vh;
      overflow-y: auto;
      display: none;
      text-align: center;
      z-index: 1000;
    }
    #result h2 {
      margin: 0 0 10px;
      font-size: 20px;
    }
    #result p {
      margin: 5px 0;
      font-size: 16px;
    }
    #result img {
      max-width: 100%;
      height: auto;
      border-radius: 5px;
      margin: 10px 0;
    }
    .button-group {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
    }
    .button-group button {
      padding: 12px 24px;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      flex: 1;
      min-width: 120px;
    }
    #google-btn {
      background: #4285F4;
      color: white;
    }
    #redirect-btn {
      background: #4CAF50;
      color: white;
    }
    #dismiss-btn {
      background: #ccc;
      color: black;
    }
    #retry-button {
      background: #ff9800;
      color: white;
      margin-top: 10px;
    }
    #file-input {
      display: none;
    }
  </style>
  <script src="https://unpkg.com/@zxing/library@0.19.2/umd/index.min.js"></script>
</head>
<body>
  <div id="status">Ready to scan</div>
  <button id="capture-button">Take Photo to Scan</button>
  <img id="photo-preview" src="" alt="Photo Preview">
  <input type="file" id="file-input" accept="image/*" capture="environment">
  <div id="result">
    <h2>Scan Result</h2>
    <p id="barcode-type"></p>
    <p id="barcode-value"></p>
    <img id="itemImage" src="" alt="" style="display: none;">
    <p id="item-name"></p>
    <div class="button-group">
      <button id="google-btn">Google the code</button>
      <button id="redirect-btn">Go to Item Page</button>
      <button id="dismiss-btn">Scan Again</button>
    </div>
  </div>

  <script>
    window.onload = async function() {
      const captureButton = document.getElementById('capture-button');
      const fileInput = document.getElementById('file-input');
      const photoPreview = document.getElementById('photo-preview');
      const resultDiv = document.getElementById('result');
      const barcodeType = document.getElementById('barcode-type');
      const barcodeValue = document.getElementById('barcode-value');
      const itemImage = document.getElementById('itemImage');
      const itemName = document.getElementById('item-name');
      const googleBtn = document.getElementById('google-btn');
      const redirectBtn = document.getElementById('redirect-btn');
      const dismissBtn = document.getElementById('dismiss-btn');
      const status = document.getElementById('status');

      const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzD-kW76mbuh3ZZWe7ZB3kIkgVTYmsMJ7uluEcknSpxlCE3vKwMhoE8roTTAVhe3jmX/exec';

      let codeReader = new ZXing.BrowserMultiFormatReader();

      async function scanPhoto(file) {
        try {
          status.textContent = 'Processing photo...';
          photoPreview.src = URL.createObjectURL(file);
          photoPreview.style.display = 'block';

          const hints = new Map();
          hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [
            ZXing.BarcodeFormat.EAN_13,
            ZXing.BarcodeFormat.UPC_A,
            ZXing.BarcodeFormat.CODE_128,
            ZXing.BarcodeFormat.QR_CODE
          ]);
          hints.set(ZXing.DecodeHintType.TRY_HARDER, true);

          const result = await codeReader.decodeFromImage(photoPreview, hints);
          const barcode = result.text;
          let format = result.format.replace('ZXing.', '');
          console.log(`[DEBUG] Detected barcode: ${barcode}, format: ${format}`);
          status.textContent = `Scanned barcode: ${barcode}`;

          try {
            status.textContent = 'Fetching item data...';
            console.log(`[DEBUG] Fetching data for barcode: ${barcode}`);
            const response = await fetch(`${GOOGLE_APPS_SCRIPT_URL}?code=${barcode}`);
            if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
            const data = await response.json();
            console.log(`[DEBUG] Fetch response:`, data);

            barcodeType.textContent = `Type: ${format}`;
            barcodeValue.textContent = `Value: ${barcode}`;
            if (data.error || !data.itemName) {
              itemName.textContent = 'Item not found';
              itemImage.style.display = 'none';
            } else {
              itemName.textContent = `Item: ${data.itemName}`;
              if (data.imageUrl) {
                itemImage.src = data.imageUrl;
                itemImage.style.display = 'block';
              } else {
                itemImage.style.display = 'none';
              }
            }
            resultDiv.style.display = 'block';
            photoPreview.style.display = 'none';
            status.style.display = 'none';
          } catch (fetchErr) {
            console.error('Fetch error:', fetchErr);
            status.textContent = `Error: ${fetchErr.message}`;
            setTimeout(() => {
              resultDiv.style.display = 'block';
              barcodeType.textContent = 'Error';
              barcodeValue.textContent = `Error fetching item: ${fetchErr.message}`;
              itemImage.style.display = 'none';
              photoPreview.style.display = 'none';
              status.style.display = 'none';
            }, 5000);
          }

          googleBtn.onclick = () => {
            window.open(`https://www.google.com/search?q=${barcode}`, '_blank');
          };

          redirectBtn.onclick = () => {
            const itemPage = `item.html?code=${barcode}&name=${encodeURIComponent(data.itemName || 'Not Found')}&image=${encodeURIComponent(data.imageUrl || '')}`;
            window.location.href = itemPage;
          };

          dismissBtn.onclick = () => {
            codeReader = new ZXing.BrowserMultiFormatReader();
            resultDiv.style.display = 'none';
            photoPreview.style.display = 'none';
            status.style.display = 'block';
            status.textContent = 'Ready to scan';
          };
        } catch (err) {
          console.error('Decoding error:', err);
          status.textContent = `Error decoding barcode: ${err.message}. Please retake with a clear image.`;
          // Keep photo preview visible for user to check
          // Add retry button or delay reset
          setTimeout(() => {
            status.textContent = 'Ready to scan';
            // photoPreview.style.display = 'none'; // Uncomment to hide preview if desired
          }, 5000);
        }
      }

      captureButton.onclick = () => {
        fileInput.click();
      };

      fileInput.onchange = (event) => {
        const file = event.target.files[0];
        if (file) {
          scanPhoto(file);
        }
      };
    };
  </script>
</body>
</html>
